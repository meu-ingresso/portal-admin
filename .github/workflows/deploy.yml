name: Deploy Application

on:
  push:
    branches:
      - main
      - staging

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

      - name: Run Deploy Script
        run: |
          BRANCH=${{ github.ref_name }}
          echo "üåø Branch detectada: $BRANCH"

          if [ "$BRANCH" == "main" ]; then
            ENVIRONMENT="prod"
            PM2_NAME="portal-admin-prod"
          elif [ "$BRANCH" == "staging" ]; then
            ENVIRONMENT="staging"
            PM2_NAME="portal-admin-staging"
          else
            echo "‚ùå Branch $BRANCH n√£o configurada para deploy."
            exit 1
          fi

          ssh -o StrictHostKeyChecking=no ubuntu@18.207.6.216 << EOF
            export NVM_DIR="/home/ubuntu/.nvm"
            [ -s "\$NVM_DIR/nvm.sh" ] && \. "\$NVM_DIR/nvm.sh"
            export PATH="\$PATH:/home/ubuntu/.yarn/bin"
            export ENVIRONMENT=$ENVIRONMENT
            export BRANCH=$BRANCH
            export PM2_NAME=$PM2_NAME

            echo "üîç Ambiente detectado: \$ENVIRONMENT"
            if [ ! -d "/home/ubuntu/Projetos/portal-admin-\$ENVIRONMENT" ]; then
              echo "‚ùå Diret√≥rio /home/ubuntu/Projetos/portal-admin-\$ENVIRONMENT n√£o encontrado."
              exit 1
            fi

            cd /home/ubuntu/Projetos/portal-admin-\$ENVIRONMENT

            echo "‚åõ‚è≥ REALIZANDO PULL ... ‚åõ‚è≥"
            git checkout \$BRANCH
            git pull

            echo "‚åõ‚è≥ INSTALANDO AS DEPEND√äNCIAS ... ‚åõ‚è≥"
            yarn || { echo "‚ùå Erro ao instalar depend√™ncias."; exit 1; }

            echo "‚åõ‚è≥ COMPILANDO APLICA√á√ÉO... ‚åõ‚è≥"
            yarn build || { echo "‚ùå Erro ao compilar a aplica√ß√£o."; exit 1; }

            echo "‚åõ‚è≥ Verificando PM2 ‚åõ‚è≥"
            if ! command -v pm2 &> /dev/null
            then
              echo "‚ùå PM2 n√£o encontrado. Verifique a instala√ß√£o ou o PATH."
              exit 1
            fi

            echo "üöÄ REINICIANDO APLICA√á√ÉO COM PM2 üöÄ"

            echo \$PM2_NAME

            pm2 restart \$PM2_NAME || { echo "‚ùå Erro ao reiniciar aplica√ß√£o no PM2."; exit 1; }
            pm2 save || { echo "‚ùå Erro ao salvar estado do PM2."; exit 1; }

            echo "‚úÖ‚úÖ‚úÖ DEPLOY FINALIZADO PARA O AMBIENTE \$ENVIRONMENT ‚úÖ‚úÖ‚úÖ"
          EOF
